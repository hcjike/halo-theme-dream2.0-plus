name: Sync to Gitee (Mirror)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches: [ master ]
  pull_request_target:
    branches: [ master ]
    types: [ closed ]
  workflow_dispatch:

env:
  GITEE_REPO: "https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/hcjike/halo-theme-dream2.0-plus.git"
  GITEA_REPO: "https://${{ secrets.GITEA_USERNAME }}:${{ secrets.GITEA_TOKEN }}@code.hcjike.com/hcjike/halo-theme-dream2.0-plus.git"

jobs:
  mirror:
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'pull_request_target' && 
       github.event.pull_request.merged == true)

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha || github.sha }}

      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@github.com"
          git config --global http.postBuffer 524288000

      - name: Sync to Gitee
        run: |
          echo "Syncing to Gitee..."
          GITEE_URL="${{ env.GITEE_REPO }}"
          
          # 添加 Gitee 远程
          git remote add gitee $GITEE_URL || true
          
          # 强制推送到 Gitee（包括所有分支和标签）
          git push gitee --all --force
          git push gitee --tags --force
          
          echo "✅ Successfully synced to Gitee"

      - name: Sync to Gitea (safe method)
        run: |
          echo "Syncing to Gitea..."
          GITEA_URL="${{ env.GITEA_REPO }}"
          
          # 添加 Gitea 远程
          git remote add gitea $GITEA_URL || true
          
          # 1. 先推送非 master 分支
          echo "Pushing non-master branches..."
          for branch in $(git branch -r | grep -v '\->' | sed "s,.*/,,g" | grep -v 'master' | grep -v 'HEAD'); do
            echo "Pushing branch: $branch"
            git push gitea "refs/remotes/origin/$branch:refs/heads/$branch" --force || true
          done
          
          # 2. 推送所有标签
          echo "Pushing all tags..."
          git push gitea --tags --force || true
          
          # 3. 最后推送 master 分支（不删除，只覆盖）
          echo "Pushing master branch (force update)..."
          git push gitea origin/master:master --force-with-lease
          
          echo "✅ Successfully synced to Gitea"